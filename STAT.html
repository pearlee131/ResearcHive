<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ResearcHive</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="LOGO.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background-color: #f8fbff;
            overflow-x: hidden;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: -230px;
            width: 230px;
            height: 100%;
            background-color: #d8e9ff;
            transition: left 0.3s ease;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .sidebar.active { left: 0; }
        .sidebar-header {
            display: flex;
            align-items: center;
            padding: 10px;
            font-weight: bold;
            color: #002b5b;
            font-size: 18px;
        }
        .sidebar-header img {
            height: 35px;
            width: 35px;
            margin-right: 8px;
        }
        .sidebar a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            text-decoration: none;
            color: #002b5b;
            font-weight: bold;
            transition: background 0.2s, color 0.2s;
        }
        .sidebar a:hover {
            background-color: #002b5b;
            color: #ffffff;
        }
        .sidebar a.active-link {
            background-color: #002b5b;
            color: #ffffff;
        }
        .sidebar a i { margin-right: 10px; }
        .sidebar-section-gap {
            margin: 5px 0;
            border-top: 2px solid #a5c0ff;
        }
        
       
        .topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: #e8f1ff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1001;
        }
        .menu-toggle {
            font-size: 24px;
            cursor: pointer;
            color: #002b5b;
            margin-right: 10px;
        }
        .logo {
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 20px;
            color: #002b5b;
        }
        .logo img {
            height: 30px;
            margin-right: 8px;
        }
        .admin-profile {
            position: relative;
            display: flex;
            align-items: center;
            font-weight: bold;
            color: #002b5b;
            cursor: pointer;
        }
        
        .admin-profile-dropdown {
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            background-color: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            min-width: 150px;
            z-index: 1002;
            display: none; 
        }
        .admin-profile-dropdown a {
            color: #002b5b;
            padding: 10px 15px;
            text-decoration: none;
            display: flex; 
            align-items: center; 
            font-weight: normal;
        }
        .admin-profile-dropdown a i { margin-right: 8px; }
        .admin-profile-dropdown a:hover { background-color: #f0f6ff; }
        
        .main {
            margin-top: 75px;
            margin-left: 20px;
            margin-right: 20px;
            padding: 20px;
            transition: margin-left 0.3s ease;
            min-height: calc(93vh - 40px); 
        }
        .main.shifted { margin-left: 230px; }
       

.stats-layout {
    display: flex;
    gap: 20px;
}



.left-col {
    flex: 0 0 40%;
    display: flex;
    flex-direction: column;
    gap: 20px;
    
}


.right-col {
    flex: 0 0 60%;
    display: flex;
    flex-direction: column;
    gap: 20px;
     padding-right: 15px; 
}


.stat-card {
    background: #fff;
    border-radius: 15px;
    border: 1px solid #a5c0ff;
    padding: 20px; 
    box-shadow: 5px 5px 5px #a9b3be;
}

.stat-card h3 {
    margin-bottom: 15px;
    font-size: 16px;
    color: #002b5b;
}


.greeting-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-image: url('SG.png');
    border: 1px solid #a5c0ff;
    background-size: cover;
    background-position: center;
    border-radius: 15px;
    padding: 25px 30px;
    color: #fff;
    overflow: hidden;
}

.greeting-content h2 {
    font-size: 22px;
    font-weight: bold;
    margin-bottom: 8px;
}

.greeting-content p {
    font-size: 14px;
    margin-bottom: 15px;
}

.generate-btn {
    background-color: #ffffff;
    color: #002b5b;
    border: none;
    border-radius: 25px;
    padding: 10px 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
}

.generate-btn:hover {
    background-color: #f0f6ff;
}

.generate-btn:active {
    transform: scale(1.15); 
}


.chart-container {
    width: 100%;
    height: 205px; 
}

.chart-container.small {
    height: 205px; 
}

.chart-container.large {
    height: 320px; 
}

.chart-container canvas {
    width: 100% !important;
    height: 100% !important;
}
html, body {
    height: 100%;
    overflow-y: hidden;
}


.modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: #fff;
  border-radius: 8px;
  border: 2px solid #002b5b;
  padding: 20px 25px;
  width: 500px;
  box-shadow: 0px 7px 10px rgba(0,0,0,0.2);
  animation: fadeIn 0.3s ease;
}

.modal-content h3 {
  margin-bottom: 15px;
  font-size: 20px;
  color: #002b5b;
  display: flex;
  align-items: center;
  gap: 8px;
  padding-bottom: 8px;
}

.modal-content label {
  font-size: 17px;
  font-weight: bold;
  margin: 10px 0 5px;
  display: block;
  color: #002b5b;
}

.modal-content select {
  width: 100%;
  padding: 8px;
  font-size: 16px;
  border: 2px solid #002b5b;
  border-radius: 5px;
}

.radio-group {
  display: flex;
  gap: 15px;
  margin: 8px 0 15px;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 15px;
}

#closeModal {
  background: transparent;
  border: none;
  font-size: 16px;
  color: #002b5b;
  font-weight: bold;
  cursor: pointer;
  padding-right: 285px;
}



.submit-btn {
  background: #007bff;
  color: #fff;
  font-size: 16px;
  border: none;
  padding: 8px 14px;
  border-radius: 5px;
  cursor: pointer;
}

.submit-btn:hover {
  background: #0056b3;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}
.status-group {
  display: flex;
  gap: 20px;
  margin: 10px 0 20px;
}

.status-group label {
  font-size: 15px;
  font-weight: normal;
  color: #002b5b;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}


.status-group input[type="checkbox"] {
  appearance: none; 
  width: 18px;
  height: 18px;
  border: 2px solid #002b5b;
  border-radius: 50%;
  display: inline-block;
  position: relative;
  cursor: pointer;
}

.status-group input[type="checkbox"]:checked {
  background-color: #002b5b;
}

.status-group input[type="checkbox"]:checked::after {
  content: "";
  position: absolute;
  top: 4px;
  left: 4px;
  width: 8px;
  height: 8px;
  background: white;
  border-radius: 50%;
}

.circle-group {
  display: flex;
  gap: 20px;
  margin: 10px 0 20px;
  flex-wrap: wrap;
}

.circle-group label {
  font-size: 15px;
  font-weight: normal;
  color: #002b5b;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}


.circle-group input[type="checkbox"],
.circle-group input[type="radio"] {
  appearance: none;
  width: 18px;
  height: 18px;
  border: 2px solid #002b5b;
  border-radius: 50%;
  cursor: pointer;
  position: relative;
}


.circle-group input[type="checkbox"]:checked::after,
.circle-group input[type="radio"]:checked::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 8px;
  height: 8px;
  background: #002b5b;
  border-radius: 50%;
  transform: translate(-50%, -50%);
}

/* Notification / pill (centered top) */
#notif-container {
  position: fixed;
  top: 18px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 3000;
  pointer-events: none;                 /* allow clicks through except the pill */
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  width: auto;
  max-width: calc(100% - 40px);
}

/* pill itself */
.notification {
  pointer-events: auto;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 420px;
  max-width: 980px;
  padding: 14px 42px;
  border-radius: 999px;                 /* pill shape */
  border: 3px solid #063a6b;            /* dark blue outer ring like your screenshot */
  background: linear-gradient(#eef6ff, #eaf3ff); /* subtle blue gradient */
  color: #063a6b;
  font-weight: 700;
  font-size: 18px;
  box-shadow: 0 10px 18px rgba(0,0,0,0.25);
  text-align: center;
  transition: transform 220ms ease, opacity 220ms ease;
  opacity: 1;
}

/* smaller width for narrow screens */
@media (max-width: 600px) {
  .notification { min-width: 260px; padding: 10px 18px; font-size: 15px; }
}

/* hide animation */
.notification.hide {
  opacity: 0;
  transform: translateY(-10px) scale(0.98);
}

/* type modifiers (optional) */

.notification.success { border-color:#063a6b; color: #063a6b; background: linear-gradient(#eef6ff,#eaf3ff); }
.notification.warning { border-color: #063a6b; color: #063a6b; background: linear-gradient(#eef6ff,#eaf3ff); }


    </style>
</head>
<body>

  <!-- Notification container (paste near top of <body>) -->
<div id="notif-container" aria-live="polite" aria-atomic="true"></div>


<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <img src="images/LOGO.png" alt="Logo">
        ResearcHive
    </div>
    <a href="DASHBOARD.HTML"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
    <div class="sidebar-section-gap"></div>
    <a href="DEPT.html"><i class="fas fa-building"></i> Department List</a>
    <a href="PROGRAM.html"><i class="fas fa-graduation-cap"></i> Program List</a>
    <a href="MANUSCRIPT.html"><i class="fas fa-folder-open"></i> Research Profile</a>
    <a href="STAT.html" class="active-link"><i class="fas fa-chart-bar"></i> Statistics</a>
    <a href="SETTING.html"><i class="fas fa-cog"></i> Settings</a>
</div>

<div class="topbar">
    <div class="logo">
  <i class="fas fa-bars menu-toggle" id="menuToggle"></i>
  <a href="DASHBOARD.html" style="display:flex; align-items:center; text-decoration:none; color:inherit;">
    <img src="LOGO.png" alt="Logo">
    <span style="font-weight:bold; font-size:20px; margin-left:8px;">ResearcHive</span>
  </a>
</div>

    <div class="admin-profile" id="adminProfileBtn">
        <i class="fas fa-user-circle"></i>&nbsp; <span id="adminName">Admin</span>
        <div class="admin-profile-dropdown" id="adminDropdown">
            <a href="LOGIN.HTML"><i class="fas fa-sign-out-alt"></i> Log Out</a>
        </div>
    </div>
</div>


<div id="generateModal" class="modal">
  <div class="modal-content">
    <h3><i class="fas fa-print"></i> List Details</h3>
    <form>
      <label>Department</label>
<select id="deptSelect">
    
</select>

<label>Program</label>
<select id="programSelect">
    <option value="all">Select All</option>
</select>

<label id="majorLabel" style="display:none;">Major</label>
<select id="majorSelect" style="display:none;">
</select>



<label>Year Authored</label>
<select id="yearSelect">
  
</select>

<label>Adviser</label>
<div style="display: flex; gap: 8px; flex-wrap: nowrap;">
  <input type="text" id="advFirst" placeholder="First Name" 
         style="flex:1; min-width:0; border:2px solid #002b5b; border-radius:5px; padding:6px;">
  <input type="text" id="advMid" placeholder="Middle Initial" 
         style="flex:1; min-width:0; border:2px solid #002b5b; border-radius:5px; padding:6px; text-align:center;">
  <input type="text" id="advLast" placeholder="Last Name" 
         style="flex:1; min-width:0; border:2px solid #002b5b; border-radius:5px; padding:6px;">
  <input type="text" id="advSuffix" placeholder="Suffix" 
         style="flex:1; min-width:0; border:2px solid #002b5b; border-radius:5px; padding:6px;">
</div>



      <label>Status</label>
<div class="circle-group">
  <label><input type="checkbox" name="status" value="Protected"> Protected</label>
  <label><input type="checkbox" name="status" value="Published"> Published</label>
  <label><input type="checkbox" name="status" value="Presented"> Presented</label>
  <label><input type="checkbox" name="status" value="Extended"> Extended</label>
</div>



      <label>Generate as</label>
<div class="circle-group">
  <label><input type="radio" name="format" value="PDF" checked> PDF</label>
</div>


      <div class="modal-actions">
        <button type="button" id="closeModal">Cancel</button>
        <button type="submit" class="submit-btn">Generate</button>
      </div>
    </form>
  </div>
</div>

<div class="main" id="main">
    <div class="stats-layout">
       
        <div class="left-col">
            <div class="stat-card">
                <h3>Department Overview</h3>
                <div class="chart-container small">
                    <canvas id="deptChart"></canvas>
                </div>
            </div>

            <div class="stat-card">
                <h3>Program Overview</h3>
                <div class="chart-container">
                    <canvas id="programChart"></canvas>
                </div>
            </div>
        </div> 

     
        <div class="right-col">
           
            <div class="greeting-card">
                <div class="greeting-content">
                    <h2>Hello Admin!</h2>
                    <p>Buzz detected! <br> Latest ResearcHive insights are now ready to explore!</p>
                   
                    <button id="openModal" class="generate-btn"><i class="fas fa-print"></i> Generate List</button>
                </div>
            </div>

            <div class="stat-card">
  <h3>Yearly Overview</h3>
  <div class="chart-container large">
    <canvas id="yearlyChart"></canvas>
  </div>
</div>

        </div>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  /* ---------------------------------------------------
   ðŸ§© STEP 1: GLOBAL SUPABASE INITIALIZATION (KEEP ONLY THIS ONE)
--------------------------------------------------- */
const SUPABASE_URL = "https://ckuhctjmvpxffyprmatx.supabase.co"; // your project URL
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrdWhjdGptdnB4ZmZ5cHJtYXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3MDMzNDUsImV4cCI6MjA3MTI3OTM0NX0.n6YLr6jnZdj4HtIWao7iOh2kygEpfqph-eZW37k8BWg"; // copy from Supabase â†’ Settings â†’ API â†’ anon public key
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window.supabaseClient = supabaseClient; 

// âœ… Supabase connection test (runs safely inside async block)



document.addEventListener("DOMContentLoaded", async () => {

  
  

  // ðŸ”¹ Restore local session first
  const storedProfile = localStorage.getItem("rh_profile");
  let profile = null;
  if (storedProfile) {
    try { profile = JSON.parse(storedProfile); } catch {}
  }

  // ðŸ”¹ Sidebar toggle (just in case topbar exists)
  const menuToggle = document.getElementById("menuToggle");
  const sidebar = document.getElementById("sidebar");
  const mainContent = document.getElementById("main");
  if (menuToggle) {
    menuToggle.addEventListener("click", () => {
      sidebar.classList.toggle("active");
      mainContent.classList.toggle("shifted");

      
    });

  }

  // ðŸ”¹ Admin dropdown setup
  const adminProfileBtn = document.getElementById("adminProfileBtn");
  const adminDropdown = document.getElementById("adminDropdown");
  const adminNameEl = document.getElementById("adminName");

  if (adminProfileBtn) {
    adminProfileBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      adminDropdown.style.display =
        adminDropdown.style.display === "block" ? "none" : "block";
    });
    window.addEventListener("click", (e) => {
      if (!adminProfileBtn.contains(e.target))
        adminDropdown.style.display = "none";
    });
  }

  // ðŸ”¹ Display admin name if found
  if (profile) {
    const deptName = profile.department_name || "";
    let label = "Admin";
    if (profile.role === "super_admin") label = "Librarian";
    else if (profile.role === "admin" && deptName)
      label = `${deptName} Admin`;
    if (adminNameEl) adminNameEl.textContent = label;
  }

  // ðŸ”¹ Soft check Supabase (no instant redirect)
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user && !profile) {
    console.warn("No user found, redirecting...");
    window.location.href = "LOGIN.html";
    return;
  }

  // ðŸ”¹ Keep session active
  supabaseClient.auth.onAuthStateChange((event, session) => {
    if (event === "SIGNED_OUT" && !localStorage.getItem("rh_profile")) {
      console.warn("Session ended, redirecting...");
      window.location.href = "LOGIN.html";
    }
  });

  // âœ… Expose Supabase client globally for other scripts
 

   await loadDepartments();
  await loadYears();
  await loadDeptChart();
  await loadProgramChart();
  await loadYearlyChart();
});




/* --- Notification helper --- */
function showNotification(message, type = 'warning', timeout = 3800) {
  let container = document.getElementById('notif-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'notif-container';
    container.setAttribute('aria-live', 'polite');
    document.body.appendChild(container);
  }

  const note = document.createElement('div');
  note.className = 'notification ' + type;
  note.setAttribute('role', 'status');
  note.innerText = message;

  container.appendChild(note);

  // Auto-hide
  setTimeout(() => {
    note.classList.add('hide');
    note.addEventListener('transitionend', () => note.remove(), { once: true });
  }, timeout);
}



const openModalBtn = document.getElementById("openModal");
const modal = document.getElementById("generateModal");
const closeModal = document.getElementById("closeModal");

if (openModalBtn) {
  openModalBtn.addEventListener("click", (e) => {
    e.preventDefault();
    modal.style.display = "flex";
  });
}

if (closeModal) {
  closeModal.addEventListener("click", () => {
    modal.style.display = "none";
  });
}

window.addEventListener("click", (e) => {
  if (modal && e.target === modal) {
    modal.style.display = "none";
  }
});

window.addEventListener("click", (e) => {
  if (e.target === modal) {
    modal.style.display = "none";
  }
});

const deptSelect = document.getElementById("deptSelect");
const programSelect = document.getElementById("programSelect");
const majorSelect = document.getElementById("majorSelect");
const majorLabel = document.getElementById("majorLabel");
const yearSelect = document.getElementById("yearSelect");

async function loadDepartments() {
  const { data, error } = await supabaseClient
    .from("programs")
    .select("department");

  if (error) {
    console.error("Error fetching departments:", error);
    return;
  }

  const uniqueDepartments = [...new Set(data.map(item => item.department))];

  // --- Determine logged-in role ---
  const storedProfile = localStorage.getItem("rh_profile");
  let profile = storedProfile ? JSON.parse(storedProfile) : null;
  const role = profile?.role || "";
  const deptName = profile?.department_name || "";

  deptSelect.innerHTML = "";

  // --- Librarian (super_admin): show all + "Select All"
  if (role === "super_admin") {
    deptSelect.innerHTML += '<option value="all">Select All</option>';
    uniqueDepartments.forEach(dept => {
      deptSelect.innerHTML += `<option value="${dept}">${dept}</option>`;
    });
  } 
  // --- Department admins: only their own department ---
  else if (role === "admin" && ["COM", "CCS", "COED", "COAG"].includes(deptName)) {
    deptSelect.innerHTML += `<option value="${deptName}">${deptName}</option>`;
    // ðŸ”¹ Automatically load that departmentâ€™s programs
    await loadPrograms(deptName);
  }
}



async function loadPrograms(department) {
  if (!department) return;

  let query = supabaseClient.from("programs").select("program_name, majors");
  if (department !== "all") query = query.eq("department", department);

  const { data, error } = await query;
  if (error) {
    console.error("Error fetching programs:", error);
    return;
  }

  programSelect.innerHTML = "";

  // --- If more than one program, show "Select All" ---
  if (data.length > 1) {
    programSelect.innerHTML += '<option value="all">Select All</option>';
  }

  data.forEach(item => {
    const majorsArray = Array.isArray(item.majors)
      ? item.majors
      : (item.majors && item.majors.trim() !== "" ? item.majors.split(",").map(m => m.trim()) : []);
    const majorsString = majorsArray.join(",");

    programSelect.innerHTML += `<option value="${item.program_name}" data-majors="${majorsString}">${item.program_name}</option>`;
  });

  // Hide major dropdown until program is selected
  majorSelect.style.display = "none";
  majorLabel.style.display = "none";
}



async function loadYears() {
  const { data, error } = await supabaseClient
    .from("manuscripts")
    .select("year_authored");

  if (error) {
    console.error("Error fetching years:", error);
    return;
  }

  const uniqueYears = [...new Set(data.map(item => item.year_authored))]
    .filter(y => y !== null && y !== "") 
    .sort((a, b) => a - b);

  yearSelect.innerHTML = '<option value="all">Select All</option>';
  uniqueYears.forEach(y => {
    yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
  });
}


deptSelect.addEventListener("change", (e) => {
  const selectedDept = e.target.value;
  loadPrograms(selectedDept);
});

programSelect.addEventListener("change", (e) => {
  
  const selectedOption = e.target.selectedOptions[0];
  const majorsString = selectedOption.dataset.majors || '';
  let majors = [];

  if (majorsString.trim() !== "") {
    
    majors = majorsString.split(',').map(m => m.trim());
  }

  if (majors.length > 0 && selectedOption.value !== "all") {
    majorSelect.innerHTML = '<option value="all">Select All</option>';
    majors.forEach(major => {
      majorSelect.innerHTML += `<option value="${major}">${major}</option>`;
    });
    
    majorSelect.style.display = "block";
    majorLabel.style.display = "block";
  } else {
    majorSelect.style.display = "none";
    majorLabel.style.display = "none";
  }
});


document.querySelector("#generateModal form").addEventListener("submit", async (e) => {
  e.preventDefault();

    if (typeof supabaseClient === "undefined" || !supabaseClient) {
    showNotification("Initializing connection... please try again.", "warning", 3000);
    return;
  }


  const department = deptSelect.value;
  const program = programSelect.value;
  const major = majorSelect.style.display !== "none" ? majorSelect.value : null;
  const year = yearSelect.value;

  // Adviser input fields
  const advFirst = document.getElementById("advFirst").value.trim();
  const advMid = document.getElementById("advMid").value.trim();
  const advLast = document.getElementById("advLast").value.trim();
  const advSuffix = document.getElementById("advSuffix").value.trim();
  let adviserSearch = [advFirst, advMid, advLast, advSuffix]
    .filter(x => x !== "")
    .join(" ");

  // âœ… Create query first
  let query = supabaseClient.from("manuscripts").select("*");

  if(department !== "all") query = query.eq("department", department);
  if(program !== "all") query = query.eq("program", program);
  if(major && major !== "all") query = query.eq("major", major);
  if(year !== "all") query = query.eq("year_authored", year);

  // âœ… Adviser filter safely applied
  if (adviserSearch) {
    query = query.ilike("adviser", `%${adviserSearch}%`);
  }

  const statuses = Array.from(document.querySelectorAll('input[name="status"]:checked'))
    .map(input => input.value);
  if(statuses.length > 0) {
    const statusFilters = statuses.map(s => `status.ilike.%${s}%`).join(",");
    query = query.or(statusFilters);
  }

  const format = document.querySelector('input[name="format"]:checked').value;
  const { data, error } = await query;

  if (error) {
  showNotification("Error fetching data: " + (error.message || "Unknown error"), 'error', 4500);
  return;
}

if (!data || data.length === 0) {
  showNotification("No data found for the selected filters.", 'warning', 3800);
  return;
}


  data.sort((a, b) => (a.title || "").localeCompare(b.title || ""));

  if(format === "PDF") {
    generatePDF(data);
    showNotification("Research list generated successfully!", 'success', 3000);

  }
});

// âœ… Fixed generatePDF with Adviser column
async function generatePDF(data) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "mm", "a4");

  // Helper to load image â†’ DataURL
  function loadImageToDataURL(src) {
    return new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        resolve(canvas.toDataURL("image/png"));
      };
      img.onerror = () => resolve(null);
      img.src = src;
    });
  }

  // Load logos
  const logoHeaderLeft  = await loadImageToDataURL("logo_header_left.png");
  const logoHeaderRight = await loadImageToDataURL("logo_header_right.png");
  const logoFooterRight1 = await loadImageToDataURL("logo_footer_right1.png");
  const logoFooterRight2 = await loadImageToDataURL("logo_footer_right2.png");

  const hasMajor = data.some(item => item.major && item.major.toString().trim() !== "");

  const columns = [
  { header: "#", dataKey: "index" },
  { header: "Title", dataKey: "title" },
  { header: "Authors", dataKey: "authors" },
  { header: "Adviser", dataKey: "adviser" },
  { header: "Year", dataKey: "year" },
  { header: "Department", dataKey: "department" },
  { header: "Program", dataKey: "programMajor" }, // merged column
  { header: "Status", dataKey: "status" }
];

  const rows = data.map((item, index) => ({
  index: index + 1,
  title: item.title || "N/A",
  authors: Array.isArray(item.authors) ? item.authors.join(", ") : item.authors || "N/A",
  adviser: item.adviser || "N/A",
  year: item.year_authored || "N/A",
  department: item.department || "N/A",
  programMajor: item.major 
      ? `${item.program || "N/A"} - ${item.major}` 
      : (item.program || "N/A"),
  status: item.status || "-"
}));


 doc.autoTable({
  startY: 49,   // Always after header area on first page
  head: [columns.map(c => c.header)],
  body: rows.map(r => columns.map(c => r[c.dataKey])),
  styles: { fontSize: 9, cellPadding: 3, halign: "left", valign: "middle" },
  headStyles: { fillColor: [0, 43, 91], textColor: 255 },
  alternateRowStyles: { fillColor: [240, 246, 255] },
  margin: { left: 14, right: 14, top: 70, bottom: 25 },

  didDrawPage: function (data) {
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    // --- HEADER ---
    if (logoHeaderLeft)  doc.addImage(logoHeaderLeft,  "PNG", 10, 1, 33, 39);
    if (logoHeaderRight) doc.addImage(logoHeaderRight, "PNG", pageWidth - 43, 1, 30, 35);

    doc.setFontSize(9).setFont(undefined, "normal").setTextColor(0,0,0);
    doc.text("Republic of the Philippines", pageWidth / 2, 13, { align: "center" });

    doc.setFontSize(10).setFont(undefined, "bold").setTextColor(70,130,180);
    doc.text("ILOILO STATE UNIVERSITY OF FISHERIES SCIENCE AND TECHNOLOGY", pageWidth / 2, 18, { align: "center" });

    doc.setFontSize(9).setFont(undefined, "normal").setTextColor(0,0,0);
    doc.text("San Enrique, Iloilo | email: sanenriquecampus@gmail.com", pageWidth / 2, 23, { align: "center" });
    doc.text("Website: isufst.edu.ph | Contact No: (+63) 931-835-3246", pageWidth / 2, 27, { align: "center" });

    // --- Blue line ---
    doc.setDrawColor(70, 130, 180).setLineWidth(0.2);
    doc.line(14, 31, pageWidth - 14, 31);

    // --- Title only on first page ---
    if (data.pageNumber === 1) {
      doc.setFontSize(14).setFont(undefined, "bold").setTextColor(0,0,0);
      doc.text("Research Manuscript List", pageWidth / 2, 40, { align: "center" });

      doc.setFontSize(11).setFont(undefined, "italic").setTextColor(100);
      doc.text("Generated by: ResearcHive", pageWidth / 2, 45, { align: "center" });

      // Push table down further on first page
      data.settings.margin.top = 55;
    } else {
      // For page 2+ keep table closer to header
      data.settings.margin.top = 35;
    }

    // --- Footer ---
    doc.setDrawColor(150).setLineWidth(0.5);
    doc.line(14, pageHeight - 25, pageWidth - 14, pageHeight - 25);

    const footerY = pageHeight - 27;
    if (logoFooterRight1) doc.addImage(logoFooterRight1, "PNG", pageWidth - 85, footerY, 30, 25);
    if (logoFooterRight2) doc.addImage(logoFooterRight2, "PNG", pageWidth - 60, footerY, 28, 25);

    doc.setFontSize(9).setFont(undefined, "italic").setTextColor(0,0,0);
    doc.text("Integrity  Â·  Social Justice  Â·  Discipline  Â·  Academic Excellence", pageWidth / 6, pageHeight - 15, { align: "left" });
  }
});


  doc.save("Research List.pdf");
}





  
const ctxDept = document.getElementById("deptChart").getContext("2d");
let deptChart; 

async function loadDeptChart() {
  const { data, error } = await supabaseClient
    .from("manuscripts")
    .select("department");

  if (error) {
    console.error("Error fetching manuscripts:", error);
    return;
  }

  const counts = {};
  data.forEach(item => {
    if (item.department) {
      counts[item.department] = (counts[item.department] || 0) + 1;
    }
  });

  // âœ… Rename short codes to full names
  const renameMap = {
    "COM": "College of Management",
    "COED": "College of Education",
    "CCS": "College of Computer Studies",
    "COAG": "College of Agriculture"
  };

  // âœ… Fixed color per department
  const colorMap = {
    "College of Management": "#bb5759",   
    "College of Education": "#70a8e5",    
    "College of Computer Studies": "#ff99d8", 
    "College of Agriculture": "#1ddd92",  
    "Others": "#2a3674"                   // purple fallback
  };

  const labels = Object.keys(counts).map(dep => renameMap[dep] || dep);
  const values = Object.values(counts);

  // Match each label to its color (fallback if not in map)
  const backgroundColors = labels.map(label => colorMap[label] || colorMap["Others"]);

  if (deptChart) deptChart.destroy();

  deptChart = new Chart(ctxDept, {
    type: "doughnut",
    data: {
      labels: labels,
      datasets: [
        {
          data: values,
          backgroundColor: backgroundColors,
          borderWidth: 3,
          borderColor: "#fff",
          hoverOffset: 15
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: "right",
          labels: {
            font: { size: 13, weight: "bold" },
            usePointStyle: true,
            padding: 15
          }
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              return context.label + ": " + context.parsed + " manuscripts";
            }
          }
        }
      },
      cutout: "55%" 
    }
  });
}



const ctxProgram = document.getElementById("programChart").getContext("2d");
let programChart; 

async function loadProgramChart() {
  // 1. Fetch program â†’ department map
  const { data: programs, error: pError } = await supabaseClient
    .from("programs")
    .select("program_name, department");

  if (pError) {
    console.error("Error fetching programs:", pError);
    return;
  }

  // âœ… Normalize department codes to full names
  const renameMap = {
    "COM": "College of Management",
    "COED": "College of Education",
    "CCS": "College of Computer Studies",
    "COAG": "College of Agriculture"
  };

  const programDeptMap = {};
  programs.forEach(p => {
    const normalizedDept = renameMap[p.department] || p.department || "Others";
    programDeptMap[p.program_name] = normalizedDept;
  });

  // 2. Count manuscripts per program
  const { data: manuscripts, error: mError } = await supabaseClient
    .from("manuscripts")
    .select("program");

  if (mError) {
    console.error("Error fetching manuscripts:", mError);
    return;
  }

  const counts = {};
  manuscripts.forEach(item => {
    if (item.program) {
      counts[item.program] = (counts[item.program] || 0) + 1;
    }
  });

  const labels = Object.keys(counts);
  const values = Object.values(counts);

  // âœ… Department â†’ Color mapping
  const colorMap = {
    "College of Management": "#bb5759",   
    "College of Education": "#70a8e5",    
    "College of Computer Studies": "#ff99d8", 
    "College of Agriculture": "#1ddd92",  
    "Others": "#2a3674"
  };

  // Assign program colors based on normalized department
  const backgroundColors = labels.map(programName => {
    const dept = programDeptMap[programName] || "Others";
    return colorMap[dept] || colorMap["Others"];
  });

  if (programChart) programChart.destroy();

  programChart = new Chart(ctxProgram, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        {
          data: values,
          backgroundColor: backgroundColors,
          borderWidth: 1
        }
      ]
    },
    options: {
      indexAxis: "y",
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function (context) {
              const programName = context.label;
              const count = context.parsed.x;
              const dept = programDeptMap[programName] || "Others";
              return `${programName} (${dept}): ${count} manuscripts`;
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: { stepSize: 2 },
          grid: { display: false }
        },
        y: {
          grid: { display: false }
        }
      }
    }
  });
}


const ctxYearly = document.getElementById("yearlyChart").getContext("2d");
let yearlyChart; 

async function loadYearlyChart() {
  const { data, error } = await supabaseClient
    .from("manuscripts")
    .select("year_authored, department");

  if (error) {
    console.error("Error fetching manuscripts:", error);
    return;
  }

  const yearCounts = {}; 
  const deptBreakdown = {}; 

  data.forEach(item => {
    if (item.year_authored) {
      const year = item.year_authored;
      const dept = item.department || "Unknown";

    
      yearCounts[year] = (yearCounts[year] || 0) + 1;

      if (!deptBreakdown[year]) deptBreakdown[year] = {};
      deptBreakdown[year][dept] = (deptBreakdown[year][dept] || 0) + 1;
    }
  });

  
  const labels = Object.keys(yearCounts).sort((a, b) => a - b);
  const values = labels.map(year => yearCounts[year]);

  
  const gradient = ctxYearly.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, "rgba(30,144,255,0.4)");
  gradient.addColorStop(1, "rgba(30,144,255,0)");


  if (yearlyChart) yearlyChart.destroy();

  yearlyChart = new Chart(ctxYearly, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Manuscripts",
          data: values,
          fill: true,
          backgroundColor: gradient,
          borderColor: "#1E90FF",
          tension: 0.4,
          borderWidth: 2,
          pointBackgroundColor: "#1E90FF",
          pointRadius: 5,
          pointHoverRadius: 7,
          pointHoverBackgroundColor: "#fff",
          pointHoverBorderColor: "#1E90FF"
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
         
            label: (ctx) => {
              const year = ctx.label;
              const total = ctx.parsed.y;
              let lines = [`${total} manuscripts total`];

              if (deptBreakdown[year]) {
                Object.entries(deptBreakdown[year]).forEach(([dept, count]) => {
                  lines.push(`â€¢ ${dept}: ${count}`);
                });
              }
              return lines;
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false }, 
          ticks: { color: "#555" }
        },
        y: {
          beginAtZero: true,
          grid: { display: false }, 
          ticks: { color: "#555" }
        }
      }
    }
  });
}




</script>

</body>
</html>  